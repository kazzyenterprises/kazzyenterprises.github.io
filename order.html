<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Page - Kazzy Enterprises</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    section.order-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
    }
    section.order-form label,
    section.order-form select,
    section.order-form input {
      display: block;
      width: 100%;
      margin-bottom: 10px;
    }

    .row-with-button {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .row-with-button button {
      flex: 1;
      padding: 8px;
      font-size: 1rem;
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .row-with-button button:hover {
      background-color: #5a6268;
    }

    .contact-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .contact-row label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .contact-prefix {
      font-weight: bold;
      margin-right: 5px;
      white-space: nowrap;
    }

    #contact-no {
      width: 100px;
    }

    #order-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #order-table th, #order-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }
    .category-col { width: 30%; }
    .item-col     { width: 30%; }
    .count-col    { width: 10%; text-align: center; }
    .margin-col   { width: 15%; }
    .mrp-col      { width: 15%; }
    #order-table th:last-child,
    #order-table td:last-child {
      width: 1px;
      text-align: center;
    }
    .delete-btn {
      background: none;
      border: none;
      color: red;
      font-size: 1.2rem;
      cursor: pointer;
    }
    tfoot td {
      font-weight: bold;
      text-align: right;
      padding-top: 12px;
    }
    .button-row {
      display: flex;
      gap: 10px;
    }
    button.full-width-btn {
      flex: 1;
      padding: 12px;
      font-size: 1.2rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    button.full-width-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    button.full-width-btn:hover:not(:disabled) {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <section class="order-form">
    <h1>Place Order</h1>

    <span id="order-id-display">Order ID: Generating...</span>

    <label>Date: <input type="date" id="order-date" readonly></label>
    <label>Time: <input type="time" id="order-time" readonly></label>

    <label>Route:
      <select id="route"></select>
    </label>

    <label>Place:
      <select id="place"></select>
    </label>

    <div class="row-with-button">
      <label style="flex: 0 0 70%;">Shop Name:
        <select id="shop-name"></select>
      </label>
      <button id="shop-image-btn" type="button">Shop Image</button>
    </div>

    <div class="contact-row">
      <label>Contact No:
        <span class="contact-prefix">+91</span>
        <input type="text" id="contact-no" maxlength="10" placeholder="">
      </label>
    </div>

    <label>Email: <input type="email" id="email"></label>
    <label>Location: <input type="text" id="location"></label>

    <div id="order-sections">
      <table id="order-table">
        <thead>
          <tr>
            <th class="category-col">Category</th>
            <th class="item-col">Item</th>
            <th class="count-col">Count</th>
            <th class="margin-col">Margin Rate</th>
            <th class="mrp-col">Actual MRP</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="order-tbody"></tbody>
        <tfoot>
          <tr>
            <td colspan="6" id="grand-total">Total: 0.00</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="button-row">
      <button id="add-category" class="full-width-btn">Add Category & Item</button>
    </div>

    <label>Expected Delivery Date:
      <input type="date" id="delivery-date">
    </label>

    <div class="row-with-button">
      <button id="item-image-btn" type="button">Item Image</button>
    </div>

    <button id="place-order" class="full-width-btn" style="display:none;">Place Order</button>

    <h2>Add New Product to DB</h2>
    <label>Category: <input type="text" id="new-category"></label>
    <label>Product Name: <input type="text" id="new-product"></label>
    <button id="add-product">Add Product</button>
  </section>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const USER_ID = "demo-user-1";

    let productCache = [];
    let draftOrderState = { rows: [] };

    const orderDateInput = document.getElementById("order-date");
    const orderTimeInput = document.getElementById("order-time");
    const deliveryDateInput = document.getElementById("delivery-date");
    const routeSelect = document.getElementById("route");
    const placeSelect = document.getElementById("place");
    const shopSelect = document.getElementById("shop-name");
    const contactInput = document.getElementById("contact-no");
    const emailInput = document.getElementById("email");
    const locationInput = document.getElementById("location");
    const orderIdDisplay = document.getElementById("order-id-display");
    const orderTbody = document.getElementById("order-tbody");
    const addCategoryBtn = document.getElementById("add-category");
    const placeOrderBtn = document.getElementById("place-order");
    const grandTotalCell = document.getElementById("grand-total");

    // âœ… restrict contact input to digits only
    contactInput.addEventListener("input", (e) => {
      contactInput.value = contactInput.value.replace(/\D/g, "").slice(0, 10);
    });

    window.addEventListener("DOMContentLoaded", async () => {
      const now = new Date();
      orderDateInput.value = now.toISOString().split("T")[0];
      orderTimeInput.value = now.toTimeString().slice(0, 5);
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      deliveryDateInput.value = tomorrow.toISOString().split("T")[0];

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          locationInput.value = `${pos.coords.latitude}, ${pos.coords.longitude}`;
        }, () => { locationInput.placeholder = "Enter Location Manually"; });
      }

      const productsSnap = await db.collection("products").get();
      productCache = productsSnap.docs.map(d => d.data());

      const draftDoc = await db.collection("draftOrders").doc(USER_ID).get();
      if (draftDoc.exists) {
        draftOrderState = draftDoc.data();
        restoreDraftToTable();
      }

      generateOrderId();
    });

    function restoreDraftToTable() {
      orderTbody.innerHTML = "";
      draftOrderState.rows.forEach(row => createRow(row));
      if (draftOrderState.rows.length > 0) placeOrderBtn.style.display = "block";
      updateGrandTotal();
    }

    async function saveDraftToFirestore() {
      await db.collection("draftOrders").doc(USER_ID).set(draftOrderState);
    }

    function createRow(rowData = {}) {
      const tr = document.createElement("tr");
      tr.className = "order-category";

      const categorySelect = document.createElement("select");
      const categories = [...new Set(productCache.map(p => p.category))];
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
      categorySelect.value = rowData.category || categories[0] || "";

      const itemSelect = document.createElement("select");
      populateItems(categorySelect.value, itemSelect);
      itemSelect.value = rowData.item || "";

      const countInput = document.createElement("input");
      countInput.type = "number";
      countInput.className = "count-input";
      countInput.min = 1;
      countInput.max = 999;
      countInput.step = 1;
      countInput.value = rowData.count || 1;

      const marginInput = document.createElement("input");
      marginInput.type = "number";
      marginInput.className = "margin-input";
      marginInput.step = "0.01";
      marginInput.value = rowData.margin || "";

      const mrpInput = document.createElement("input");
      mrpInput.type = "number";
      mrpInput.className = "mrp-input";
      mrpInput.step = "0.01";
      mrpInput.value = rowData.mrp || "";

      categorySelect.addEventListener("change", () => {
        populateItems(categorySelect.value, itemSelect);
        updateDraftState();
      });
      itemSelect.addEventListener("change", updateDraftState);
      countInput.addEventListener("input", () => { enforceCountBounds(countInput); updateDraftState(); });
      marginInput.addEventListener("input", updateDraftState);
      mrpInput.addEventListener("input", updateDraftState);

      tr.appendChild(createTd(categorySelect, "category-col"));
      tr.appendChild(createTd(itemSelect, "item-col"));
      tr.appendChild(createTd(countInput, "count-col"));
      tr.appendChild(createTd(marginInput, "margin-col"));
      tr.appendChild(createTd(mrpInput, "mrp-col"));

      const deleteTd = document.createElement("td");
      const deleteBtn = document.createElement("button");
      deleteBtn.type = "button";
      deleteBtn.className = "delete-btn";
      deleteBtn.innerHTML = "ðŸ—‘ï¸";
      deleteBtn.addEventListener("click", () => {
        tr.remove();
        updateDraftState();
      });
      deleteTd.appendChild(deleteBtn);
      tr.appendChild(deleteTd);

      orderTbody.appendChild(tr);
    }

    function populateItems(category, selectEl) {
      selectEl.innerHTML = "";
      const items = productCache.filter(p => p.category === category);
      items.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.name;
        opt.textContent = p.name;
        selectEl.appendChild(opt);
      });
    }

    function updateDraftState() {
      draftOrderState.rows = [];
      document.querySelectorAll("tr.order-category").forEach(tr => {
        const selects = tr.querySelectorAll("select");
        const inputs = tr.querySelectorAll("input");
        draftOrderState.rows.push({
          category: selects[0].value,
          item: selects[1].value,
          count: parseInt(inputs[0].value, 10),
          margin: parseFloat(inputs[1].value) || 0,
          mrp: parseFloat(inputs[2].value) || 0
        });
      });
      updateGrandTotal();
      saveDraftToFirestore();
    }

    function createTd(el, cls = "") {
      const td = document.createElement("td");
      if (cls) td.className = cls;
      td.appendChild(el);
      return td;
    }

    function enforceCountBounds(input) {
      let v = Number(input.value);
      if (!Number.isFinite(v) || isNaN(v)) v = 1;
      v = Math.floor(v);
      if (v < 1) v = 1;
      if (v > 999) v = 999;
      input.value = v;
    }

    function updateGrandTotal() {
      let total = 0;
      draftOrderState.rows.forEach(r => {
        total += r.count * r.margin;
      });
      grandTotalCell.textContent = "Total: " + total.toFixed(2);
    }

    addCategoryBtn.addEventListener("click", async () => {
      addCategoryBtn.disabled = true;
      createRow();
      updateDraftState();
      await saveDraftToFirestore();
      addCategoryBtn.disabled = false;
      placeOrderBtn.style.display = "block";
    });

    placeOrderBtn.addEventListener("click", async () => {
      const orderId = orderIdDisplay.dataset.orderId;
      const fullContact = "+91" + contactInput.value;
      await db.collection("orders").add({
        userId: USER_ID,
        orderId,
        date: orderDateInput.value,
        time: orderTimeInput.value,
        route: routeSelect.value,
        place: placeSelect.value,
        shop: shopSelect.value,
        contact: fullContact,
        email: emailInput.value,
        location: locationInput.value,
        deliveryDate: deliveryDateInput.value,
        orders: draftOrderState.rows,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      await db.collection("draftOrders").doc(USER_ID).delete();
      alert("Order placed successfully!");
      location.reload();
    });

    async function generateOrderId() {
      const now = new Date();
      const month = now.toLocaleString('en-US',{month:'short'}).toUpperCase();
      const day = String(now.getDate()).padStart(2,"0");
      const prefix = `${month}${day}`;
      const snap = await db.collection("orders").orderBy("timestamp","desc").limit(1).get();
      let count = 1;
      if (!snap.empty) {
        const lastId = snap.docs[0].data().orderId || "";
        if (lastId.startsWith(prefix)) {
          const num = parseInt(lastId.split("/")[1]);
          count = num+1;
        }
      }
      const orderId = `${prefix}/${String(count).padStart(4,"0")}`;
      orderIdDisplay.textContent = `Order ID: ${orderId}`;
      orderIdDisplay.dataset.orderId = orderId;
    }
  </script>
</body>
</html>

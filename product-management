<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Manage Products</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 20px; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
    button { margin-top: 15px; padding: 10px; background: #007BFF; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .success { color: green; margin-top: 10px; font-weight: bold; }
    .error { color: red; margin-top: 10px; font-weight: bold; }
    .variant { display:flex; gap:8px; }
    .variant input { flex:2; }
    .variant select { flex:1; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Manage Products</h2>

    <!-- Category -->
    <label>Category</label>
    <input list="category-list" id="category" placeholder="Type or select category">
    <datalist id="category-list"></datalist>

    <!-- Product -->
    <label>Product</label>
    <input list="product-list" id="product" placeholder="Type or select product">
    <datalist id="product-list"></datalist>

    <!-- Variant -->
    <label>Variant</label>
    <div class="variant">
      <input type="number" id="variantValue" placeholder="e.g. 500">
      <select id="variantUnit">
        <option value="ml">ml</option>
        <option value="g">g</option>
        <option value="kg">kg</option>
        <option value="pcs">pcs</option>
      </select>
    </div>

    <label>MRP</label>
    <input type="number" step="0.01" id="mrp" placeholder="e.g. 48.00">

    <label>Selling Price</label>
    <input type="number" step="0.01" id="sellingPrice" placeholder="e.g. 46.00">

    <label>Stock Level</label>
    <input type="number" id="stockLevel" value="0">

    <label>Active</label>
    <select id="active">
      <option value="true">True</option>
      <option value="false" selected>False</option>
    </select>

    <button onclick="saveProduct()">Save</button>
    <p id="status"></p>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCI6ZLswuH7aZKpqt8EwGI6TWecpBQkVgo",
      authDomain: "kazzyenterprizes-c8ef7.firebaseapp.com",
      projectId: "kazzyenterprizes-c8ef7",
      storageBucket: "kazzyenterprizes-c8ef7.firebasestorage.app",
      messagingSenderId: "673988986305",
      appId: "1:673988986305:web:efbdc6283a30483f1a1b40",
      measurementId: "G-Z2W56NEGD6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const categoryInput = document.getElementById("category");
    const categoryList = document.getElementById("category-list");
    const productInput = document.getElementById("product");
    const productList = document.getElementById("product-list");
    const variantValueInput = document.getElementById("variantValue");
    const variantUnitInput = document.getElementById("variantUnit");
    const statusMsg = document.getElementById("status");

    function slugify(str) {
      return str.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");
    }

    function normalizeName(name) {
      return name.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(" ");
    }

    // Load categories
    async function loadCategories() {
      categoryList.innerHTML = "";
      const snapshot = await db.collection("products").get();
      const categories = new Set();
      snapshot.forEach(doc => {
        if (doc.data().category) categories.add(doc.data().category);
      });
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        categoryList.appendChild(opt);
      });
    }
    loadCategories();

    // Load products when category changes
    categoryInput.addEventListener("change", async () => {
      const category = categoryInput.value.trim();
      if (!category) return;
      productList.innerHTML = "";
      const snapshot = await db.collection("products").where("category", "==", category).get();
      snapshot.forEach(doc => {
        const data = doc.data();
        const opt = document.createElement("option");
        opt.value = data.name; // name includes variant
        productList.appendChild(opt);
      });
    });

    // Load product details when product selected or typed
    async function loadProductDetails() {
      const category = categoryInput.value.trim();
      const productFullName = productInput.value.trim();
      if (!category || !productFullName) return;

      // Try to find document with this category + name
      const snapshot = await db.collection("products")
        .where("category","==",category)
        .where("name","==",productFullName)
        .limit(1)
        .get();

      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        const data = doc.data();
        productInput.dataset.id = doc.id;
        variantValueInput.value = data.variantValue;
        variantUnitInput.value = data.variantUnit;
        document.getElementById("mrp").value = data.mrp || "";
        document.getElementById("sellingPrice").value = data.sellingPrice || "";
        document.getElementById("stockLevel").value = data.stockLevel || 0;
        document.getElementById("active").value = data.active ? "true" : "false";
      } else {
          productInput.dataset.id = "";
          // clear only detail fields, not variant or product
          document.getElementById("mrp").value = "";
          document.getElementById("sellingPrice").value = "";
          document.getElementById("stockLevel").value = 0;
          document.getElementById("active").value = "false";
        }
      }

    productInput.addEventListener("change", loadProductDetails);
    variantValueInput.addEventListener("change", loadProductDetails);
    variantUnitInput.addEventListener("change", loadProductDetails);

    function clearForm() {
      variantValueInput.value = "";
      variantUnitInput.value = "ml";
      document.getElementById("mrp").value = "";
      document.getElementById("sellingPrice").value = "";
      document.getElementById("stockLevel").value = 0;
      document.getElementById("active").value = "false";
    }

    async function saveProduct() {
      const category = categoryInput.value.trim();
      let productFullName = productInput.value.trim();
      const variantValue = variantValueInput.value.trim();
      const variantUnit = variantUnitInput.value;

      if (!category) return alert("Enter category");
      if (!productFullName) return alert("Enter product name");
      if (!variantValue) return alert("Enter variant value");

      // Normalize product name + include variant for storage
      const baseName = normalizeName(productFullName);
      productFullName = `${baseName} ${variantValue}${variantUnit}`;

      const docId = `${slugify(category)}_${slugify(baseName)}_${variantValue}${variantUnit}`;
      const docRef = db.collection("products").doc(docId);
      const doc = await docRef.get();

      const productData = {
        name: productFullName,
        category: category,
        variantValue: parseInt(variantValue),
        variantUnit: variantUnit,
        mrp: parseFloat(document.getElementById("mrp").value),
        sellingPrice: parseFloat(document.getElementById("sellingPrice").value),
        stockLevel: parseInt(document.getElementById("stockLevel").value),
        active: document.getElementById("active").value === "true",
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (doc.exists) {
        if (!confirm("Product exists. Update?")) return;
        await docRef.update(productData);
        statusMsg.textContent = "✅ Product updated successfully!";
      } else {
        productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        await docRef.set(productData);
        statusMsg.textContent = "✅ New product added successfully!";
      }
      statusMsg.className = "success";

      // Reset form after 2 seconds
      setTimeout(() => {
        categoryInput.value = "";
        productInput.value = "";
        productInput.dataset.id = "";
        clearForm();
        statusMsg.textContent = "";
        loadCategories();
      }, 2000);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Manage Products</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    body { 
      font-family: "Segoe UI", Arial, sans-serif; 
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); 
      margin: 20px; 
      color: white;
    }
    .container { 
      max-width: 500px; 
      margin: auto; 
      background: #111; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.4); 
    }
    h2 { 
      font-size: 1.8rem;
      color: #00d4ff;
      text-align: center; 
      margin-bottom: 20px; 
    }
    label {  
      margin-top: 10px; 
      font-weight: bold; 
    }
    input, select {
      width: 100%; 
      padding: 10px; 
      margin-top: 6px;
      border-radius: 8px; 
      border: 1px solid #666; 
      background: #111; 
      color: white;
      font-size: 1rem;
      transition: border 0.3s;
    }
    button {
      margin-top: 15px; 
      padding: 12px;
      background: #007BFF; 
      color: white;
      border: none; 
      border-radius: 6px;
      cursor: pointer; 
      font-size: 16px; 
      width: 100%;
      display: flex; 
      align-items: center; 
      justify-content: center;
      gap: 8px;
    }
    input:focus, select:focus {
      border-color: #00d4ff;
      outline: none;
    }
    button {
      display: flex;
      flex: 1;
      padding: 14px;
      font-size: 1.1rem;
      background: linear-gradient(45deg, #00d4ff, #007bff);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s, background 0.3s;
    }
    button:disabled { 
      background: #555; 
      cursor: not-allowed; 
    }
    button:hover:enabled {
      background: linear-gradient(45deg, #00ffcc, #0056b3);
      transform: translateY(-2px);
    }
    .success { 
      color: #00e676; 
      margin-top: 12px; 
      font-weight: bold; 
      text-align: center; 
    }
    .error { 
      color: #ff5252; 
      margin-top: 12px; 
      font-weight: bold; 
      text-align: center; 
    }
    .variant { 
      display:flex; 
      gap:8px; 
    }
    .variant input { 
      flex:2; 
    }
    .variant select { 
      flex:1; 
    }
    .spinner {
      width: 18px; height: 18px; border: 3px solid #fff;
      border-top: 3px solid transparent; border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚ö° Manage Products</h2>

    <!-- Category -->
    <label>üìÇ Category</label>
    <input list="category-list" id="category" placeholder="Type or select category">
    <datalist id="category-list"></datalist>

    <!-- Product -->
    <label>üõí Product</label>
    <input list="product-list" id="product" placeholder="Type or select product">
    <datalist id="product-list"></datalist>

    <!-- Variant -->
    <label>üìè Variant</label>
    <div class="variant">
      <input type="number" id="variantValue" placeholder="e.g. 500">
      <select id="variantUnit">
        <option value="ml">ml</option>
        <option value="g">g</option>
        <option value="kg">kg</option>
        <option value="pcs">pcs</option>
      </select>
    </div>

    <label>üí∞ MRP</label>
    <input type="number" step="0.01" id="mrp" placeholder="e.g. 48.00">

    <label>üè∑Ô∏è Selling Price</label>
    <input type="number" step="0.01" id="sellingPrice" placeholder="e.g. 46.00">

    <label>üì¶ Stock Level</label>
    <input type="number" id="stockLevel" value="0">

    <label>‚úÖ Active</label>
    <select id="active">
      <option value="true" selected>True</option>
      <option value="false">False</option>
    </select>

    <button id="saveBtn" onclick="saveProduct()">üíæ Save Product</button>
    <p id="status"></p>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCI6ZLswuH7aZKpqt8EwGI6TWecpBQkVgo",
      authDomain: "kazzyenterprizes-c8ef7.firebaseapp.com",
      projectId: "kazzyenterprizes-c8ef7",
      storageBucket: "kazzyenterprizes-c8ef7.firebasestorage.app",
      messagingSenderId: "673988986305",
      appId: "1:673988986305:web:efbdc6283a30483f1a1b40",
      measurementId: "G-Z2W56NEGD6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const categoryInput = document.getElementById("category");
    const categoryList = document.getElementById("category-list");
    const productInput = document.getElementById("product");
    const productList = document.getElementById("product-list");
    const variantValueInput = document.getElementById("variantValue");
    const variantUnitInput = document.getElementById("variantUnit");
    const statusMsg = document.getElementById("status");
    const saveBtn = document.getElementById("saveBtn");

    function slugify(str) {
      return str.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");
    }

    function normalizeName(name) {
      return name.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(" ");
    }

    // Load categories
    async function loadCategories() {
      categoryList.innerHTML = "";
      const snapshot = await db.collection("products").get();
      const categories = new Set();
      snapshot.forEach(doc => {
        if (doc.data().category) categories.add(doc.data().category);
      });
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        categoryList.appendChild(opt);
      });
    }
    loadCategories();

    // Load products when category changes
    categoryInput.addEventListener("change", async () => {
      const category = categoryInput.value.trim();
      if (!category) return;
      productList.innerHTML = "";
      const snapshot = await db.collection("products").where("category", "==", category).get();
      snapshot.forEach(doc => {
        const data = doc.data();
        const opt = document.createElement("option");
        opt.value = data.name; 
        productList.appendChild(opt);
      });
    });

    // Load product details
    async function loadProductDetails() {
      const category = categoryInput.value.trim();
      const productFullName = productInput.value.trim();
      if (!category || !productFullName) return;

      const snapshot = await db.collection("products")
        .where("category","==",category)
        .where("name","==",productFullName)
        .limit(1)
        .get();

      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        const data = doc.data();
        productInput.dataset.id = doc.id;
        variantValueInput.value = data.variantValue;
        variantUnitInput.value = data.variantUnit;
        document.getElementById("mrp").value = data.mrp || "";
        document.getElementById("sellingPrice").value = data.sellingPrice || "";
        document.getElementById("stockLevel").value = data.stockLevel || 0;
        document.getElementById("active").value = data.active ? "true" : "false";
      } else {
        productInput.dataset.id = "";
        document.getElementById("mrp").value = "";
        document.getElementById("sellingPrice").value = "";
        document.getElementById("stockLevel").value = 0;
        document.getElementById("active").value = "true";
      }
    }

    productInput.addEventListener("change", loadProductDetails);
    variantValueInput.addEventListener("change", loadProductDetails);
    variantUnitInput.addEventListener("change", loadProductDetails);

    function clearForm() {
      variantValueInput.value = "";
      variantUnitInput.value = "ml";
      document.getElementById("mrp").value = "";
      document.getElementById("sellingPrice").value = "";
      document.getElementById("stockLevel").value = 0;
      document.getElementById("active").value = "true";
    }

    async function saveProduct() {
      // Disable save button and show saving state
      saveBtn.disabled = true;
      saveBtn.textContent = "‚è≥ Saving...";
      statusMsg.textContent = "";
      statusMsg.className = "";

      const category = categoryInput.value.trim();
      let productFullName = productInput.value.trim();
      const variantValue = variantValueInput.value.trim();
      const variantUnit = variantUnitInput.value;

      if (!category) { alert("Enter category"); resetButton(); return; }
      if (!productFullName) { alert("Enter product name"); resetButton(); return; }
      if (!variantValue) { alert("Enter variant value"); resetButton(); return; }

      const baseName = normalizeName(productFullName);
      productFullName = `${baseName} ${variantValue}${variantUnit}`;

      const docId = `${slugify(category)}_${slugify(baseName)}_${variantValue}${variantUnit}`;
      const docRef = db.collection("products").doc(docId);
      const doc = await docRef.get();

      const productData = {
        name: productFullName,
        category: category,
        variantValue: parseInt(variantValue),
        variantUnit: variantUnit,
        mrp: parseFloat(document.getElementById("mrp").value),
        sellingPrice: parseFloat(document.getElementById("sellingPrice").value),
        stockLevel: parseInt(document.getElementById("stockLevel").value),
        active: document.getElementById("active").value === "true",
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        if (doc.exists) {
          if (!confirm("Product exists. Update?")) { resetButton(); return; }
          await docRef.update(productData);
          statusMsg.textContent = "‚úÖ Product updated successfully!";
        } else {
          productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await docRef.set(productData);
          statusMsg.textContent = "‚úÖ New product added successfully!";
        }
        statusMsg.className = "success";

        setTimeout(() => {
          categoryInput.value = "";
          productInput.value = "";
          productInput.dataset.id = "";
          clearForm();
          statusMsg.textContent = "";
          loadCategories();
        }, 2000);
      } catch (error) {
        statusMsg.textContent = "‚ùå Error saving product: " + error.message;
        statusMsg.className = "error";
      } finally {
        resetButton();
      }
    }

    function resetButton() {
      saveBtn.disabled = false;
      saveBtn.textContent = "üíæ Save Product";
    }
  </script>
</body>
</html>
